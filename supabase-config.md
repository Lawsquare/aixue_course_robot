# Supabase 集成配置指南

## 📋 **配置步骤**

### **1. 创建 Supabase 项目**

1. 访问 [https://supabase.com](https://supabase.com)
2. 注册/登录账户
3. 点击 "New Project" 创建新项目
4. 选择组织，填写项目名称、数据库密码
5. 选择地区（建议选择新加坡或香港）
6. 等待项目创建完成（约2分钟）

### **2. 获取项目配置信息**

在 Supabase 项目仪表板中：

1. 点击左侧菜单 "Settings" -> "API"
2. 复制以下信息：
   - **Project URL**：类似 `https://xxxxx.supabase.co`
   - **anon public key**：以 `eyJ` 开头的长字符串

### **3. 配置数据库表**

1. 在 Supabase 项目中，点击左侧菜单 "SQL Editor"
2. 点击 "New query"
3. 将 `supabase_setup.sql` 文件中的内容复制粘贴到编辑器
4. 点击 "Run" 执行 SQL，创建所需的表和策略

### **4. 更新前端配置**

在 `js/supabase.js` 文件中，找到以下行并替换为你的实际配置：

```javascript
// 第 4-5 行
this.supabaseUrl = 'YOUR_SUPABASE_URL';        // 替换为你的 Project URL
this.supabaseKey = 'YOUR_SUPABASE_ANON_KEY';   // 替换为你的 anon public key
```

### **5. 测试连接**

1. 打开浏览器开发者工具（F12）
2. 刷新网页
3. 在 Console 中查看是否显示 "✅ Supabase 客户端初始化成功"
4. 填写问卷并发送消息，观察是否有数据库操作的日志

---

## 🔧 **数据库表结构说明**

### **chat_sessions 表**
- 存储聊天会话信息
- 与 Dify 的 conversation_id 关联
- 记录每个会话的基本信息和消息总数

### **chat_messages 表**  
- 存储具体的聊天消息
- 区分用户消息和 AI 回复
- 支持文件附件（JSONB 格式）
- 与 chat_sessions 表关联

### **user_profiles 表**
- 存储用户档案和学习偏好
- 记录学习进度和完成的课程
- 支持个性化设置

---

## 🚀 **功能特性**

### **✅ 已实现的功能**

1. **用户身份管理**
   - 自动生成 UUID 作为用户标识
   - 本地存储与数据库同步

2. **聊天记录存储**
   - 自动保存所有对话到数据库
   - 包含文件上传记录
   - 与 Dify conversation_id 关联

3. **学习进度跟踪**
   - 课程完成状态同步
   - 学习进度百分比计算
   - 最后活动时间记录

4. **个性化上下文**
   - AI 对话包含用户历史聊天上下文
   - 传递用户学习进度给 AI
   - 支持个性化指导

5. **用户档案管理**
   - 问卷调查结果存储
   - 学习偏好和目标记录
   - 时间投入计划跟踪

### **🎯 数据用途**

1. **个性化 AI 指导**
   - 基于学习进度提供针对性建议
   - 根据用户目标调整回答策略
   - 考虑用户经验水平

2. **Q&A 数据库构建**
   - 收集常见问题和优质回答
   - 用于训练和优化 AI 模型
   - 生成 FAQ 文档

3. **学习行为分析**
   - 识别学习模式和困难点
   - 优化课程内容和顺序
   - 改进用户体验

---

## 🔐 **隐私保护**

- 使用 UUID 而非真实身份信息
- 无需注册登录系统
- 数据仅用于改进学习体验
- 符合数据最小化原则

---

## ❓ **故障排除**

### **常见问题**

1. **"Supabase 客户端初始化失败"**
   - 检查网络连接
   - 确认 URL 和 Key 配置正确
   - 查看浏览器是否阻止了外部脚本

2. **"保存消息失败"**
   - 确认数据库表已正确创建
   - 检查 RLS 策略是否正确设置
   - 查看 Supabase 项目是否暂停

3. **消息不显示上下文**
   - 确认聊天记录已保存到数据库
   - 检查 `getUserChatHistory` 方法返回数据
   - 查看控制台是否有错误信息

### **调试技巧**

1. 打开浏览器开发者工具
2. 查看 Console 日志中的 ✅ 和 ❌ 标记
3. 在 Network 选项卡中监控 API 请求
4. 在 Supabase 项目中的 "Table Editor" 查看数据

---

## 📊 **数据监控**

在 Supabase 项目仪表板中可以：

1. **Table Editor**: 查看和编辑表数据
2. **SQL Editor**: 运行查询分析数据
3. **Logs**: 查看 API 调用日志
4. **Auth**: 管理用户（本项目未使用） 