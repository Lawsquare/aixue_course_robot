# Dify 配置指南

## 🤖 **配合聊天记录功能的 Dify 配置**

### **1. 理解数据流**

```
用户消息 → 前端增强(+历史上下文+学习进度) → Dify AI → 回复 → 同时存储到 Supabase
```

### **2. Dify 应用设置优化**

#### **A. 系统提示词优化**

在 Dify 的 "Prompt Engineering" 部分，更新系统提示词：

```
你是一个专业的 AI 学习助手，专门帮助学员掌握 AI 创富技能。

**用户信息访问：**
- 用户ID: {{#user_id#}}
- 当前课程: {{#current_lesson#}}  
- 学习进度: {{#learning_progress#}}

**核心职责：**
1. 根据用户的学习进度提供个性化指导
2. 基于用户历史问题提供连贯的对话体验
3. 针对用户当前课程提供相关的深入解答
4. 鼓励用户完成学习目标并应用所学知识

**回答原则：**
- 如果消息中包含【上下文参考】，请参考用户的历史对话内容来提供更连贯的回答
- 根据学习进度调整回答的详细程度和难度
- 主动提及用户之前提过的相关问题或兴趣点
- 在适当时候询问用户的学习感受和困难点

**语言风格：**
- 亲切、耐心、专业
- 使用中文回答
- 适当使用 emoji 增加亲和力
- 鼓励性语言，帮助用户建立信心
```

#### **B. 输入变量配置**

在 Dify 应用设置中添加以下变量：

1. **user_id** (Text)
   - 描述：用户的唯一标识符
   - 默认值：`anonymous`

2. **current_lesson** (Text)  
   - 描述：用户当前学习的课程
   - 默认值：`未知`

3. **learning_progress** (Text)
   - 描述：用户的学习进度（JSON 字符串）
   - 默认值：`[]`

#### **C. 知识库配置**

1. 上传课程相关文档到 Dify 知识库
2. 在应用中启用知识库检索
3. 设置检索阈值为 0.7-0.8
4. 启用重排序以提高答案质量

### **3. API 集成要点**

#### **前端发送的数据格式**

```javascript
{
  "inputs": {
    "user_id": "uuid-string",           // 用户唯一标识
    "learning_progress": "[1.1,1.2]",   // JSON 字符串格式
    "current_lesson": "1.3"             // 当前课程
  },
  "query": "【上下文参考】\n用户: 之前的问题\nAI: 之前的回答\n\n【当前问题】\n用户的新问题",
  "user": "uuid-string",                // 用户标识
  "conversation_id": "dify-conv-id",    // 对话 ID
  "response_mode": "blocking"
}
```

#### **利用变量的提示词示例**

```
基于用户信息：
- 用户 {{#user_id#}} 当前学习课程：{{#current_lesson#}}
- 已完成课程：{{#learning_progress#}}

请根据以上信息个性化你的回答...
```

### **4. 高级功能配置**

#### **A. 工作流模式（推荐）**

使用 Dify 的 Workflow 模式可以实现更复杂的逻辑：

1. **判断节点**: 根据学习进度判断用户水平
2. **条件分支**: 针对不同课程提供不同的回答策略
3. **知识检索**: 根据当前课程检索相关资料
4. **模板节点**: 使用不同的回答模板

#### **B. 示例工作流结构**

```
开始 → 解析用户信息 → 判断学习阶段 → 知识库检索 → 生成个性化回答 → 结束
     ↓
     检查历史上下文 → 整合上下文信息 ↑
```

#### **C. 记忆功能配置**

1. 启用 Dify 的对话记忆功能
2. 设置记忆窗口大小（建议 10-20 轮对话）
3. 配置记忆摘要规则，保留重要的学习信息

### **5. 数据分析和优化**

#### **A. 日志分析**

在 Dify 的 "Logs & Ann." 部分：

1. 定期查看对话日志
2. 分析用户常见问题类型
3. 识别 AI 回答质量问题
4. 收集用户反馈数据

#### **B. 持续优化策略**

1. **每周数据回顾**
   - 查看最频繁的问题类型
   - 分析 AI 回答的准确性
   - 识别需要改进的知识点

2. **月度优化**
   - 更新知识库内容
   - 调整系统提示词
   - 优化工作流节点

3. **季度评估**
   - 分析用户学习效果
   - 评估个性化程度
   - 规划新功能开发

### **6. 与 Supabase 数据协同**

#### **A. 数据查询API（可选扩展）**

可以创建 API 端点来让 Dify 查询 Supabase 数据：

```sql
-- 查询用户学习统计
SELECT 
  COUNT(*) as total_messages,
  COUNT(CASE WHEN message_type = 'user' THEN 1 END) as user_questions,
  MAX(timestamp) as last_active
FROM chat_messages 
WHERE user_id = $1;
```

#### **B. 智能推荐**

基于 Supabase 中的数据，Dify 可以：

1. 推荐相关课程内容
2. 提供学习计划建议
3. 识别学习困难点
4. 推送复习提醒

### **7. 测试和验证**

#### **A. 功能测试清单**

- [ ] 用户身份正确传递到 Dify
- [ ] 学习进度在对话中被正确引用
- [ ] 历史上下文增强了 AI 回答质量
- [ ] 个性化建议符合用户水平
- [ ] 对话记忆功能正常工作

#### **B. 质量评估指标**

1. **相关性**: AI 回答与用户问题和学习进度的匹配度
2. **连贯性**: 考虑历史对话的回答连贯性
3. **个性化**: 针对不同用户的差异化回答
4. **准确性**: 技术内容的正确性
5. **有用性**: 回答对用户学习的实际帮助

### **8. 故障排除**

#### **常见问题**

1. **变量未传递**
   - 检查前端 `inputs` 字段格式
   - 确认 Dify 应用已配置对应变量

2. **上下文过长**
   - 限制历史消息数量（建议 5-10 条）
   - 使用摘要而非完整历史

3. **个性化效果不明显**
   - 优化系统提示词
   - 增加更多用户信息变量
   - 调整知识库检索策略

---

## 💡 **优化建议**

1. **渐进式改进**: 从基础功能开始，逐步增加复杂度
2. **数据驱动**: 基于实际使用数据优化配置
3. **用户反馈**: 定期收集用户体验反馈
4. **A/B 测试**: 对比不同配置的效果
5. **文档维护**: 及时更新配置文档和最佳实践 